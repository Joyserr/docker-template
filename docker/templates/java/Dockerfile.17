# Java 17 Docker开发环境模板
ARG JAVA_VERSION=17
FROM openjdk:${JAVA_VERSION}-slim

# 避免交互式提示
ENV DEBIAN_FRONTEND=noninteractive

# 设置时区为中国时区
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# 配置国内镜像源（Debian）
RUN sed -i 's|http://deb.debian.org/debian|https://mirrors.ustc.edu.cn/debian|g' /etc/apt/sources.list && \
    sed -i 's|http://security.debian.org|https://mirrors.ustc.edu.cn/debian-security|g' /etc/apt/sources.list

# 更新apt源并安装基础开发工具
RUN apt-get update && apt-get install -y \
    vim \
    wget \
    htop \
    tmux \
    build-essential \
    cmake \
    git \
    curl \
    bash-completion \
    sudo \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# 安装Java开发工具
RUN apt-get update && apt-get install -y \
    maven \
    gradle \
    ant \
    && rm -rf /var/lib/apt/lists/*

# 设置Java环境变量
ENV JAVA_HOME=/usr/local/openjdk-${JAVA_VERSION}
ENV PATH=$JAVA_HOME/bin:$PATH

# 安装Maven（如果系统版本太旧）
RUN wget -O /tmp/maven.tar.gz https://dlcdn.apache.org/maven/maven-3/3.9.4/binaries/apache-maven-3.9.4-bin.tar.gz && \
    tar -xzf /tmp/maven.tar.gz -C /opt/ && \
    rm /tmp/maven.tar.gz

ENV MAVEN_HOME=/opt/apache-maven-3.9.4
ENV PATH=$MAVEN_HOME/bin:$PATH

# 安装Gradle
RUN wget -O /tmp/gradle.zip https://services.gradle.org/distributions/gradle-8.4-bin.zip && \
    unzip /tmp/gradle.zip -d /opt/ && \
    rm /tmp/gradle.zip

ENV GRADLE_HOME=/opt/gradle-8.4
ENV PATH=$GRADLE_HOME/bin:$PATH

# 安装其他有用工具
RUN apt-get update && apt-get install -y \
    tree \
    less \
    jq \
    && rm -rf /var/lib/apt/lists/*

# 创建用户（与主机用户保持一致，避免权限问题）
ARG USER_NAME=sysadmin
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupadd -g ${USER_GID} ${USER_NAME} || true && \
    useradd -m -u ${USER_UID} -g ${USER_GID} -s /bin/bash ${USER_NAME} && \
    echo "${USER_NAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# 切换到用户
USER ${USER_NAME}
WORKDIR /home/${USER_NAME}

# 设置工作空间
RUN mkdir -p ~/workspace
WORKDIR /home/${USER_NAME}/workspace

# 复制自定义 bashrc 配置
COPY --chown=${USER_NAME}:${USER_NAME} docker/templates/java/bashrc /home/${USER_NAME}/.bashrc_docker

# 配置Java环境（加载 Docker 专用配置）
RUN echo "# Load Docker-specific Java configuration" >> ~/.bashrc && \
    echo "if [ -f ~/.bashrc_docker ]; then" >> ~/.bashrc && \
    echo "    source ~/.bashrc_docker" >> ~/.bashrc && \
    echo "fi" >> ~/.bashrc

# 默认启动bash
CMD ["/bin/bash"]