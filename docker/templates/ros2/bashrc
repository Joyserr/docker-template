# ROS2 Docker Container Configuration
# This file is auto-loaded when entering the container

# ============================================
# Basic Shell Configuration
# ============================================
# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# History configuration
HISTCONTROL=ignoreboth
HISTSIZE=10000
HISTFILESIZE=20000
shopt -s histappend

# Check window size after each command
shopt -s checkwinsize

# Better tab completion
if [ -f /etc/bash_completion ] && ! shopt -oq posix; then
    . /etc/bash_completion
fi

# ============================================
# Color Support
# ============================================
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# Colored GCC warnings and errors
export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

# ============================================
# ROS2 Environment Setup
# ============================================
echo "Loading ROS2 environment..."

# Workspace path (matched with docker-run.sh)
export CONTAINER_WORKSPACE=${CONTAINER_WORKSPACE:-workspace}
export WORKSPACE_PATH=~/$CONTAINER_WORKSPACE

# Source ROS2 setup
if [ -f /opt/ros/humble/setup.bash ]; then
    source /opt/ros/humble/setup.bash
    echo "✓ ROS2 Humble environment loaded"
    export ROS_DISTRO=humble
elif [ -f /opt/ros/foxy/setup.bash ]; then
    source /opt/ros/foxy/setup.bash
    echo "✓ ROS2 Foxy environment loaded"
    export ROS_DISTRO=foxy
else
    echo "⚠ ROS2 environment not found"
fi

# Source workspace setup if exists
if [ -f ~/workspace/install/setup.bash ]; then
    source ~/workspace/install/setup.bash
    echo "✓ ROS2 workspace environment loaded"
else
    echo "ℹ ROS2 workspace not built yet. Run 'colcon build' to build."
fi

# ROS2 Network Configuration
export ROS_HOSTNAME=localhost
export ROS_DOMAIN_ID=0

# ============================================
# Useful Aliases
# ============================================
# General aliases
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'

# ROS2 workspace aliases
alias rw='cd ~/workspace'
alias rs='cd ~/workspace/src'
alias rb='cd ~/workspace && colcon build'
alias rbi='cd ~/workspace && colcon build --symlink-install'
alias rcb='cd ~/workspace && rm -rf build install log'
alias rtest='cd ~/workspace && colcon test'

# ROS2 command aliases
alias rt='ros2 topic'
alias rn='ros2 node'
alias rp='ros2 param'
alias rsrv='ros2 service'
alias rmsg='ros2 msg'
alias rint='ros2 interface'
alias rrun='ros2 run'
alias rlaunch='ros2 launch'
alias rpkg='ros2 pkg'

# ROS2 utility aliases
alias rtlist='ros2 topic list'
alias rtecho='ros2 topic echo'
alias rtinfo='ros2 topic info'
alias rnlist='ros2 node list'
alias rninfo='ros2 node info'
alias rplist='ros2 param list'
alias rpget='ros2 param get'

# Development aliases
alias sorc='source ~/workspace/install/setup.bash'
alias remake='cd ~/workspace && rm -rf build install && colcon build'

# ============================================
# Useful Functions
# ============================================

# Quick ROS2 package creation
create_ros2_pkg() {
    if [ -z "$1" ]; then
        echo "Usage: create_ros2_pkg <package_name> [dependencies...]"
        return 1
    fi
    cd ~/workspace/src
    ros2 pkg create --build-type ament_cmake "$@"
    cd ~/workspace
    colcon build
}

# Find ROS2 package
find_ros2_pkg() {
    if [ -z "$1" ]; then
        echo "Usage: find_ros2_pkg <package_name>"
        return 1
    fi
    ros2 pkg prefix "$1"
}

# Quick topic echo
topic_echo() {
    if [ -z "$1" ]; then
        echo "Usage: topic_echo <topic_name>"
        return 1
    fi
    ros2 topic echo "$1"
}

# List all nodes
list_nodes() {
    ros2 node list
}

# ============================================
# Custom Prompt
# ============================================
# Show ROS_DISTRO in prompt
if [ -n "$ROS_DISTRO" ]; then
    PS1='\[\033[01;32m\](ROS2:$ROS_DISTRO)\[\033[00m\] \[\033[01;34m\]\u@\h\[\033[00m\]:\[\033[01;36m\]\w\[\033[00m\]\$ '
else
    PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
fi

# ============================================
# Welcome Message
# ============================================
echo ""
echo "=========================================="
echo "  ROS2 Docker Development Container"
echo "=========================================="
echo "  ROS Version: $ROS_DISTRO"
echo "  Workspace:   ~/workspace"
echo "  User:        $(whoami)"
echo "=========================================="
echo ""
echo "Quick Commands:"
echo "  rw, rs       - Navigate to workspace/src"
echo "  rb, rbi      - Build workspace (normal/symlink)"
echo "  sorc         - Source workspace setup"
echo "  remake       - Clean and rebuild"
echo ""
echo "ROS2 Commands:"
echo "  rt, rn, rp   - topic, node, param utilities"
echo "  rrun, rlaunch - run and launch commands"
echo ""
echo "Type 'alias' to see all available shortcuts"
echo "=========================================="
echo ""

# ============================================
# Python Environment
# ============================================
# Add local bin to PATH for pip installed packages
export PATH="$HOME/.local/bin:$PATH"

# ============================================
# Editor Configuration
# ============================================
export EDITOR=vim
export VISUAL=vim